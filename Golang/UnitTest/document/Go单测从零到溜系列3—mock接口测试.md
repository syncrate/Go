# Goå•æµ‹ä»é›¶åˆ°æºœç³»åˆ—3â€”mockæ¥å£æµ‹è¯•

2021å¹´9æœˆ15æ—¥

 

| [Golang](https://www.liwenzhou.com/categories/Golang)

 

æœ¬æ–‡æ€»é˜…è¯»é‡1133æ¬¡



è¿™æ˜¯Goè¯­è¨€å•å…ƒæµ‹è¯•ä»é›¶åˆ°æºœç³»åˆ—æ•™ç¨‹çš„ç¬¬3ç¯‡ï¼Œä»‹ç»äº†å¦‚ä½•åœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨gomockå’Œgostubå·¥å…·mockæ¥å£å’Œæ‰“æ¡©ã€‚

åœ¨ä¸Šä¸€ç¯‡[ã€ŠGoå•æµ‹ä»é›¶åˆ°æºœç³»åˆ—2â€”æ•°æ®åº“æµ‹è¯•ã€‹](https://www.liwenzhou.com/posts/Go/golang-unit-test-2/)ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨`go-sqlmock`å’Œ`miniredis`å·¥å…·è¿›è¡Œæ•°æ®åº“æµ‹è¯•ã€‚ é™¤äº†ç½‘ç»œå’Œæ•°æ®åº“ç­‰å¤–éƒ¨ä¾èµ–ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸­ä¹Ÿä¼šç»å¸¸ç”¨åˆ°å„ç§å„æ ·çš„æ¥å£ç±»å‹ã€‚æœ¬æ–‡å°±ä¸¾ä¾‹æ¥æ¼”ç¤ºå¦‚ä½•åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™å¯¹æ¥å£ç±»å‹è¿›è¡Œmockä»¥åŠå¦‚ä½•è¿›è¡Œæ‰“æ¡©ã€‚

> ã€ŠGoå•æµ‹ä»é›¶åˆ°æºœç³»åˆ—ã€‹çš„ç¤ºä¾‹ä»£ç å·²ä¸Šä¼ è‡³Githubï¼Œç‚¹å‡»ğŸ‘‰ğŸ»https://github.com/Q1mi/golang-unit-test-demo æŸ¥çœ‹å®Œæ•´æºä»£ç ã€‚

## gomock

[gomock](https://github.com/golang/mock)æ˜¯Goå®˜æ–¹æä¾›çš„æµ‹è¯•æ¡†æ¶ï¼Œå®ƒåœ¨å†…ç½®çš„testingåŒ…æˆ–å…¶ä»–ç¯å¢ƒä¸­éƒ½èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ã€‚æˆ‘ä»¬ä½¿ç”¨å®ƒå¯¹ä»£ç ä¸­çš„é‚£äº›æ¥å£ç±»å‹è¿›è¡Œmockï¼Œæ–¹ä¾¿ç¼–å†™å•å…ƒæµ‹è¯•ã€‚

### å®‰è£…mockgen

> äº’è”ç½‘å¼€æºåº“æ›´æ–°è¿­ä»£æ¯”è¾ƒå¿«ï¼Œå»ºè®®ç›´æ¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/golang/mock

é¦–å…ˆéœ€è¦ç¡®ä¿ä½ çš„`$GOPATH/bin`å·²ç»åŠ å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚

Goç‰ˆæœ¬å·<1.16æ—¶ï¼š

```bash
GO111MODULE=on go get github.com/golang/mock/mockgen@v1.6.0
```

Goç‰ˆæœ¬>=1.16æ—¶ï¼š

```bash
go install github.com/golang/mock/mockgen@v1.6.0
```

å¦‚æœæ˜¯åœ¨ä½ çš„CIæµæ°´çº¿ä¸­å®‰è£…ï¼Œåˆ™éœ€è¦å®‰è£…ä¸ä½ çš„CIç¯å¢ƒåŒ¹é…çš„åˆé€‚ç‰ˆæœ¬ã€‚

### è¿è¡Œmockgen

`mockgen` æœ‰ä¸¤ç§æ“ä½œæ¨¡å¼ï¼šæºç ï¼ˆsourceï¼‰æ¨¡å¼å’Œåå°„ï¼ˆreflectï¼‰æ¨¡å¼ã€‚

#### æºç æ¨¡å¼

æºç æ¨¡å¼æ ¹æ®æºæ–‡ä»¶mockæ¥å£ã€‚å®ƒæ˜¯é€šè¿‡ä½¿ç”¨ `-source` æ ‡å¿—å¯ç”¨ã€‚åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹å¯èƒ½æœ‰ç”¨çš„å…¶ä»–æ ‡å¿—æ˜¯ `-imports` å’Œ `-aux_files`ã€‚

ä¾‹å¦‚ï¼š

```bash
mockgen -source=foo.go [other options]
```

#### åå°„æ¨¡å¼

åå°„æ¨¡å¼é€šè¿‡æ„å»ºä½¿ç”¨åå°„æ¥ç†è§£æ¥å£çš„ç¨‹åºæ¥mockæ¥å£ã€‚å®ƒæ˜¯é€šè¿‡ä¼ é€’ä¸¤ä¸ªéæ ‡å¿—å‚æ•°æ¥å¯ç”¨çš„ï¼šä¸€ä¸ªå¯¼å…¥è·¯å¾„å’Œä¸€ä¸ªé€—å·åˆ†éš”çš„ç¬¦å·åˆ—è¡¨ã€‚å¯ä»¥ä½¿ç”¨ â€.â€å¼•ç”¨å½“å‰è·¯å¾„çš„åŒ…ã€‚

ä¾‹å¦‚ï¼š

```bash
mockgen database/sql/driver Conn,Driver

# Convenient for `go:generate`.
mockgen . Conn,Driver
```

### flags

`mockgen` å‘½ä»¤ç”¨æ¥ä¸ºç»™å®šä¸€ä¸ªåŒ…å«è¦mockçš„æ¥å£çš„Goæºæ–‡ä»¶ï¼Œç”Ÿæˆmockç±»æºä»£ç ã€‚å®ƒæ”¯æŒä»¥ä¸‹æ ‡å¿—ï¼š

- `-source`ï¼šåŒ…å«è¦mockçš„æ¥å£çš„æ–‡ä»¶ã€‚
- `-destination`ï¼šç”Ÿæˆçš„æºä»£ç å†™å…¥çš„æ–‡ä»¶ã€‚å¦‚æœä¸è®¾ç½®æ­¤é¡¹ï¼Œä»£ç å°†æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚
- `-package`ï¼šç”¨äºç”Ÿæˆçš„æ¨¡æ‹Ÿç±»æºä»£ç çš„åŒ…åã€‚å¦‚æœä¸è®¾ç½®æ­¤é¡¹åŒ…åé»˜è®¤åœ¨åŸåŒ…åå‰æ·»åŠ `mock_`å‰ç¼€ã€‚
- `-imports`ï¼šåœ¨ç”Ÿæˆçš„æºä»£ç ä¸­ä½¿ç”¨çš„æ˜¾å¼å¯¼å…¥åˆ—è¡¨ã€‚å€¼ä¸ºfoo=bar/bazå½¢å¼çš„é€—å·åˆ†éš”çš„å…ƒç´ åˆ—è¡¨ï¼Œå…¶ä¸­bar/bazæ˜¯è¦å¯¼å…¥çš„åŒ…ï¼Œfooæ˜¯è¦åœ¨ç”Ÿæˆçš„æºä»£ç ä¸­ç”¨äºåŒ…çš„æ ‡è¯†ç¬¦ã€‚
- `-aux_files`ï¼šéœ€è¦å‚è€ƒä»¥è§£å†³çš„é™„åŠ æ–‡ä»¶åˆ—è¡¨ï¼Œä¾‹å¦‚åœ¨ä¸åŒæ–‡ä»¶ä¸­å®šä¹‰çš„åµŒå…¥å¼æ¥å£ã€‚æŒ‡å®šçš„å€¼åº”ä¸ºfoo=bar/baz.goå½¢å¼çš„ä»¥é€—å·åˆ†éš”çš„å…ƒç´ åˆ—è¡¨ï¼Œå…¶ä¸­bar/baz.goæ˜¯æºæ–‡ä»¶ï¼Œfooæ˜¯`-source`æ–‡ä»¶ä½¿ç”¨çš„æ–‡ä»¶çš„åŒ…åã€‚
- `-build_flags`ï¼šï¼ˆä»…åå°„æ¨¡å¼ï¼‰ä¸€å­—ä¸å·®åœ°ä¼ é€’æ ‡å¿—ç»™go build
- `-mock_names`ï¼šç”Ÿæˆçš„æ¨¡æ‹Ÿçš„è‡ªå®šä¹‰åç§°åˆ—è¡¨ã€‚è¿™è¢«æŒ‡å®šä¸ºä¸€ä¸ªé€—å·åˆ†éš”çš„å…ƒç´ åˆ—è¡¨ï¼Œå½¢å¼ä¸º`Repository = MockSensorRepository,Endpoint=MockSensorEndpoint`ï¼Œå…¶ä¸­`Repository`æ˜¯æ¥å£åç§°ï¼Œ`mockSensorrepository`æ˜¯æ‰€éœ€çš„mockåç§°(mockå·¥å‚æ–¹æ³•å’Œmockè®°å½•å™¨å°†ä»¥mockå‘½å)ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªæ¥å£æ²¡æœ‰æŒ‡å®šè‡ªå®šä¹‰åç§°ï¼Œåˆ™å°†ä½¿ç”¨é»˜è®¤å‘½åçº¦å®šã€‚
- `-self_package`ï¼šç”Ÿæˆçš„ä»£ç çš„å®Œæ•´åŒ…å¯¼å…¥è·¯å¾„ã€‚ä½¿ç”¨æ­¤flagçš„ç›®çš„æ˜¯é€šè¿‡å°è¯•åŒ…å«è‡ªå·±çš„åŒ…æ¥é˜²æ­¢ç”Ÿæˆä»£ç ä¸­çš„å¾ªç¯å¯¼å…¥ã€‚å¦‚æœmockçš„åŒ…è¢«è®¾ç½®ä¸ºå®ƒçš„ä¸€ä¸ªè¾“å…¥(é€šå¸¸æ˜¯ä¸»è¾“å…¥)ï¼Œå¹¶ä¸”è¾“å‡ºæ˜¯stdioï¼Œé‚£ä¹ˆmockgenå°±æ— æ³•æ£€æµ‹åˆ°æœ€ç»ˆçš„è¾“å‡ºåŒ…ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‘ç”Ÿã€‚è®¾ç½®æ­¤æ ‡å¿—å°†å‘Šè¯‰ mockgen æ’é™¤å“ªä¸ªå¯¼å…¥
- `-copyright_file`ï¼šç”¨äºå°†ç‰ˆæƒæ ‡å¤´æ·»åŠ åˆ°ç”Ÿæˆçš„æºä»£ç ä¸­çš„ç‰ˆæƒæ–‡ä»¶
- `-debug_parser`ï¼šä»…æ‰“å°è§£æå™¨ç»“æœ
- `-exec_only`ï¼šï¼ˆåå°„æ¨¡å¼ï¼‰ å¦‚æœè®¾ç½®ï¼Œåˆ™æ‰§è¡Œæ­¤åå°„ç¨‹åº
- `-prog_only`ï¼šï¼ˆåå°„æ¨¡å¼ï¼‰åªç”Ÿæˆåå°„ç¨‹åºï¼›å°†å…¶å†™å…¥æ ‡å‡†è¾“å‡ºå¹¶é€€å‡ºã€‚
- `-write_package_comment`ï¼šå¦‚æœä¸ºtrueï¼Œåˆ™å†™å…¥åŒ…æ–‡æ¡£æ³¨é‡Š (godoc)ã€‚ï¼ˆé»˜è®¤ä¸ºtrueï¼‰

### æ„å»ºmock

è¿™é‡Œå°±ä»¥æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ç”¨åˆ°çš„æ•°æ®åº“æ“ä½œä¸ºä¾‹ï¼Œè®²è§£ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨gomockæ¥mockæ¥å£çš„å•å…ƒæµ‹è¯•ã€‚

å‡è®¾æœ‰æŸ¥è¯¢MySQLæ•°æ®åº“çš„ä¸šåŠ¡ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­`DB`æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ¥å£ç±»å‹ï¼š

```go
// db.go

// DB æ•°æ®æ¥å£
type DB interface {
	Get(key string)(int, error)
	Add(key string, value int) error
}


// GetFromDB æ ¹æ®keyä»DBæŸ¥è¯¢æ•°æ®çš„å‡½æ•°
func GetFromDB(db DB, key string) int {
	if v, err := db.Get(key);err == nil{
		return v
	}
	return -1
}
```

æˆ‘ä»¬ç°åœ¨è¦ä¸º`GetFromDB`å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ä»£ç ï¼Œå¯æ˜¯æˆ‘ä»¬åˆä¸èƒ½åœ¨å•å…ƒæµ‹è¯•è¿‡ç¨‹ä¸­è¿æ¥çœŸå®çš„æ•°æ®åº“ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦mock `DB`è¿™ä¸ªæ¥å£æ¥æ–¹ä¾¿è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

ä½¿ç”¨ä¸Šé¢æåˆ°çš„ `mockgen` å·¥å…·æ¥ä¸ºç”Ÿæˆç›¸åº”çš„mockä»£ç ã€‚é€šè¿‡æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨å½“å‰é¡¹ç›®ä¸‹ç”Ÿæˆä¸€ä¸ª`mocks`æ–‡ä»¶å¤¹ï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€ä¸ª`db_mock.go`æ–‡ä»¶ã€‚

```bash
 mockgen -source=db.go -destination=mocks/db_mock.go -package=mocks
```

`db_mock.go`æ–‡ä»¶ä¸­çš„å†…å®¹å°±æ˜¯mockç›¸å…³æ¥å£çš„ä»£ç äº†ã€‚

æˆ‘ä»¬é€šå¸¸ä¸éœ€è¦ç¼–è¾‘å®ƒï¼Œåªéœ€è¦åœ¨å•å…ƒæµ‹è¯•ä¸­æŒ‰ç…§è§„å®šçš„æ–¹å¼ä½¿ç”¨å®ƒä»¬å°±å¯ä»¥äº†ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ç¼–å†™`TestGetFromDB` å‡½æ•°å¦‚ä¸‹ï¼š

```go
// db_test.go

func TestGetFromDB(t *testing.T) {
	// åˆ›å»ºgomockæ§åˆ¶å™¨ï¼Œç”¨æ¥è®°å½•åç»­çš„æ“ä½œä¿¡æ¯
	ctrl := gomock.NewController(t)
	// æ–­è¨€æœŸæœ›çš„æ–¹æ³•éƒ½è¢«æ‰§è¡Œ
	// Go1.14+çš„å•æµ‹ä¸­ä¸å†éœ€è¦æ‰‹åŠ¨è°ƒç”¨è¯¥æ–¹æ³•
	defer ctrl.Finish()
	// è°ƒç”¨mockgenç”Ÿæˆä»£ç ä¸­çš„NewMockDBæ–¹æ³•
	// è¿™é‡Œmocksæ˜¯æˆ‘ä»¬ç”Ÿæˆä»£ç æ—¶æŒ‡å®šçš„packageåç§°
	m := mocks.NewMockDB(ctrl)
	// æ‰“æ¡©ï¼ˆstubï¼‰
	// å½“ä¼ å…¥Getå‡½æ•°çš„å‚æ•°ä¸ºliwenzhou.comæ—¶è¿”å›1å’Œnil
	m.
		EXPECT().
		Get(gomock.Eq("liwenzhou.com")). // å‚æ•°
		Return(1, nil).                  // è¿”å›å€¼
		Times(1)                         // è°ƒç”¨æ¬¡æ•°

	// è°ƒç”¨GetFromDBå‡½æ•°æ—¶ä¼ å…¥ä¸Šé¢çš„mockå¯¹è±¡m
	if v := GetFromDB(m, "liwenzhou.com"); v != 1 {
		t.Fatal()
	}
}
```

### æ‰“æ¡©ï¼ˆstubï¼‰

è½¯ä»¶æµ‹è¯•ä¸­çš„æ‰“æ¡©æ˜¯æŒ‡ç”¨ä¸€äº›ä»£ç ï¼ˆæ¡©stubï¼‰ä»£æ›¿ç›®æ ‡ä»£ç ï¼Œé€šå¸¸ç”¨æ¥å±è”½æˆ–è¡¥é½ä¸šåŠ¡é€»è¾‘ä¸­çš„å…³é”®ä»£ç æ–¹ä¾¿è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

> å±è”½ï¼šä¸æƒ³åœ¨å•å…ƒæµ‹è¯•ç”¨å¼•å…¥æ•°æ®åº“è¿æ¥ç­‰é‡èµ„æº
>
> è¡¥é½ï¼šä¾èµ–çš„ä¸Šä¸‹æ¸¸å‡½æ•°æˆ–æ–¹æ³•è¿˜æœªå®ç°

ä¸Šé¢ä»£ç ä¸­å°±ç”¨åˆ°äº†æ‰“æ¡©ï¼Œå½“ä¼ å…¥`Get`å‡½æ•°çš„å‚æ•°ä¸º`liwenzhou.com`æ—¶å°±è¿”å›`1, nil`çš„è¿”å›å€¼ã€‚

`gomock`æ”¯æŒé’ˆå¯¹å‚æ•°ã€è¿”å›å€¼ã€è°ƒç”¨æ¬¡æ•°ã€è°ƒç”¨é¡ºåºç­‰è¿›è¡Œæ‰“æ¡©æ“ä½œã€‚

#### å‚æ•°

å‚æ•°ç›¸å…³çš„ç”¨æ³•æœ‰ï¼š - gomock.Eq(value)ï¼šè¡¨ç¤ºä¸€ä¸ªç­‰ä»·äºvalueå€¼çš„å‚æ•° - gomock.Not(value)ï¼šè¡¨ç¤ºä¸€ä¸ªévalueå€¼çš„å‚æ•° - gomock.Any()ï¼šè¡¨ç¤ºä»»æ„å€¼çš„å‚æ•° - gomock.Nil()ï¼šè¡¨ç¤ºç©ºå€¼çš„å‚æ•° - SetArg(n, value)ï¼šè®¾ç½®ç¬¬nï¼ˆä»0å¼€å§‹ï¼‰ä¸ªå‚æ•°çš„å€¼ï¼Œé€šå¸¸ç”¨äºæŒ‡é’ˆå‚æ•°æˆ–åˆ‡ç‰‡

å…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
m.EXPECT().Get(gomock.Not("q1mi")).Return(10, nil)
m.EXPECT().Get(gomock.Any()).Return(20, nil)
m.EXPECT().Get(gomock.Nil()).Return(-1, nil)
```

è¿™é‡Œå•ç‹¬è¯´ä¸€ä¸‹`SetArg`çš„é€‚ç”¨åœºæ™¯ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªéœ€è¦mockçš„æ¥å£å¦‚ä¸‹ï¼š

```go
type YourInterface {
  SetValue(arg *int)
}
```

æ­¤æ—¶ï¼Œæ‰“æ¡©çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨`SetArg`æ¥ä¿®æ”¹å‚æ•°çš„å€¼ã€‚

```go
m.EXPECT().SetValue(gomock.Any()).SetArg(0, 7)  // å°†SetValueçš„ç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®ä¸º7
```

#### è¿”å›å€¼

gomockä¸­è·Ÿè¿”å›å€¼ç›¸å…³çš„ç”¨æ³•æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

- Return()ï¼šè¿”å›æŒ‡å®šå€¼
- Do(func)ï¼šæ‰§è¡Œæ“ä½œï¼Œå¿½ç•¥è¿”å›å€¼
- DoAndReturn(func)ï¼šæ‰§è¡Œå¹¶è¿”å›æŒ‡å®šå€¼

ä¾‹å¦‚ï¼š

```go
m.EXPECT().Get(gomock.Any()).Return(20, nil)
m.EXPECT().Get(gomock.Any()).Do(func(key string) {
	t.Logf("input key is %v\n", key)
})
m.EXPECT().Get(gomock.Any()).DoAndReturn(func(key string)(int, error) {
	t.Logf("input key is %v\n", key)
	return 10, nil
})
```

#### è°ƒç”¨æ¬¡æ•°

ä½¿ç”¨gomockå·¥å…·mockçš„æ–¹æ³•éƒ½ä¼šæœ‰æœŸæœ›è¢«è°ƒç”¨çš„æ¬¡æ•°ï¼Œé»˜è®¤æ¯ä¸ªmockæ–¹æ³•åªå…è®¸è¢«è°ƒç”¨ä¸€æ¬¡ã€‚

```go
m.
	EXPECT().
	Get(gomock.Eq("liwenzhou.com")). // å‚æ•°
	Return(1, nil).                  // è¿”å›å€¼
	Times(1)                         // è®¾ç½®Getæ–¹æ³•æœŸæœ›è¢«è°ƒç”¨æ¬¡æ•°ä¸º1

// è°ƒç”¨GetFromDBå‡½æ•°æ—¶ä¼ å…¥ä¸Šé¢çš„mockå¯¹è±¡m
if v := GetFromDB(m, "liwenzhou.com"); v != 1 {
	t.Fatal()
}
// å†æ¬¡è°ƒç”¨ä¸Šæ–¹mockçš„Getæ–¹æ³•æ—¶ä¸æ»¡è¶³è°ƒç”¨æ¬¡æ•°ä¸º1çš„æœŸæœ›
if v := GetFromDB(m, "liwenzhou.com"); v != 1 {
	t.Fatal()
}
```

gomockä¸ºæˆ‘ä»¬æä¾›äº†å¦‚ä¸‹æ–¹æ³•è®¾ç½®æœŸæœ›è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚

- `Times()` æ–­è¨€ Mock æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚
- `MaxTimes()` æœ€å¤§æ¬¡æ•°ã€‚
- `MinTimes()` æœ€å°æ¬¡æ•°ã€‚
- `AnyTimes()` ä»»æ„æ¬¡æ•°ï¼ˆåŒ…æ‹¬ 0 æ¬¡ï¼‰ã€‚

#### è°ƒç”¨é¡ºåº

gomockè¿˜æ”¯æŒä½¿ç”¨`InOrder`æ–¹æ³•æŒ‡å®šmockæ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼š

```go
// æŒ‡å®šé¡ºåº
gomock.InOrder(
	m.EXPECT().Get("1"),
	m.EXPECT().Get("2"),
	m.EXPECT().Get("3"),
)

// æŒ‰é¡ºåºè°ƒç”¨
GetFromDB(m, "1")
GetFromDB(m, "2")
GetFromDB(m, "3")
```

æ­¤å¤–çŸ¥åçš„Goæµ‹è¯•åº“[testify](https://github.com/stretchr/testify)ç›®å‰ä¹Ÿæä¾›ç±»ä¼¼çš„mockå·¥å…·â€”`testify/mock`å’Œ`mockery`ã€‚

## GoStub

[GoStub](https://github.com/prashantv/gostub)ä¹Ÿæ˜¯ä¸€ä¸ªå•å…ƒæµ‹è¯•ä¸­çš„æ‰“æ¡©å·¥å…·ï¼Œå®ƒæ”¯æŒä¸ºå…¨å±€å˜é‡ã€å‡½æ•°ç­‰æ‰“æ¡©ã€‚

ä¸è¿‡æˆ‘ä¸ªäººæ„Ÿè§‰å®ƒä¸ºå‡½æ•°æ‰“æ¡©ä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä¸€èˆ¬åœ¨å•å…ƒæµ‹è¯•ä¸­åªä¼šä½¿ç”¨å®ƒæ¥ä¸ºå…¨å±€å˜é‡æ‰“æ¡©ã€‚

### å®‰è£…

```bash
go get github.com/prashantv/gostub
```

### ä½¿ç”¨ç¤ºä¾‹

è¿™é‡Œä½¿ç”¨å®˜æ–¹æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä»£ç æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨gostubä¸ºå…¨å±€å˜é‡æ‰“æ¡©ã€‚

```go
// app.go 

var (
	configFile = "config.json"
	maxNum = 10
)


func GetConfig() ([]byte, error) {
	return ioutil.ReadFile(configFile)
}


func ShowNumber()int{
	// ...
	return maxNum
}
```

ä¸Šé¢ä»£ç ä¸­å®šä¹‰äº†ä¸¤ä¸ªå…¨å±€å˜é‡å’Œä¸¤ä¸ªä½¿ç”¨å…¨å±€å˜é‡çš„å‡½æ•°ï¼Œæˆ‘ä»¬ç°åœ¨ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•ã€‚

```go
// app_test.go


import (
	"github.com/prashantv/gostub"
	"testing"
)

func TestGetConfig(t *testing.T) {
	// ä¸ºå…¨å±€å˜é‡configFileæ‰“æ¡©ï¼Œç»™å®ƒèµ‹å€¼ä¸€ä¸ªæŒ‡å®šæ–‡ä»¶
	stubs := gostub.Stub(&configFile, "./test.toml")
	defer stubs.Reset()  // æµ‹è¯•ç»“æŸåé‡ç½®
	// ä¸‹é¢æ˜¯æµ‹è¯•çš„ä»£ç 
	data, err := GetConfig()
	if err != nil {
		t.Fatal()
	}
	// è¿”å›çš„dataçš„å†…å®¹å°±æ˜¯ä¸Šé¢/tmp/test.configæ–‡ä»¶çš„å†…å®¹
	t.Logf("data:%s\n", data)
}

func TestShowNumber(t *testing.T) {
	stubs := gostub.Stub(&maxNum, 20)
	defer stubs.Reset()
	// ä¸‹é¢æ˜¯ä¸€äº›æµ‹è¯•çš„ä»£ç 
	res := ShowNumber()
	if res != 20 {
		t.Fatal()
	}
}
```

æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼ŒæŸ¥çœ‹ç»“æœï¼š

```bash
â¯ go test -v
=== RUN   TestGetConfig
    app_test.go:18: data:blog="liwenzhou.com"
--- PASS: TestGetConfig (0.00s)
=== RUN   TestShowNumber
--- PASS: TestShowNumber (0.00s)
PASS
ok      golang-unit-test-demo/gostub_demo       0.012s
```

ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨`gostub`å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¹å…¨å±€å˜é‡è¿›è¡Œæ‰“æ¡©ï¼Œå°†å…¶mockæˆæˆ‘ä»¬é¢„æœŸçš„å€¼ä»è€Œè¿›è¡Œæµ‹è¯•ã€‚

## æ€»ç»“

åœ¨æ—¥å¸¸å·¥ä½œå¼€å‘ä¸­ä¸ºä»£ç ç¼–å†™å•å…ƒæµ‹è¯•æ—¶å¦‚ä½•å¤„ç†ä»£ç ä¸­çš„æ¥å£ç±»å‹æ˜¯ååˆ†å¸¸è§çš„é—®é¢˜ï¼Œæœ¬æ–‡ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨`gomock`mockç›¸å…³æ¥å£å’Œå¦‚ä½•ä½¿ç”¨`gostub`å·¥å…·å¯¹å…¨å±€å˜é‡è¿›è¡Œæ‰“æ¡©ã€‚

åœ¨ä¸‹ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬å°†æ›´è¿›ä¸€æ­¥ï¼Œè¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ç¼–å†™å•å…ƒæµ‹è¯•æ—¶ä½¿ç”¨æ›´å…¨èƒ½çš„æ‰“æ¡©å·¥å…·â€”â€”`monkey`ã€‚